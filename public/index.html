<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Retune Web</title>
<p>retune by ear and exports to scala file</p>
<meta name="Microtonal scale generation tool" content=" .">
<meta name="Carlo Cattano" content=" .">

<link rel="stylesheet" href="styles/basic.css">
<script src="./scripts/NexusUI.js"></script>
<script src="./scripts/socket.io.js"></script>
<script	src="./scripts/Tone.js"></script>
<script src="./scripts/pitchManager.js"></script>
<script src="./scripts/midi_manager.js"></script>

<body>
  <div id="wrapper">
    <div id="first" class="main"></div>
    <div id="segundo"></div>
    <button type="button" >Load Rast</button> 
    <div id="f1"></div>
  </div>  
  <div id="piano"></div>
<script>

  var socket = io("localhost:8080");// io("xolo.dauvi.org:8080"); // set your ip here  + :8000
 
  socket.on('hello', function (data) {
    console.log(data);
  });

  socket.on('s_ratios', function (data) {       // Get ratios from server
    var ratio = data.ratio; 
    var s_freq = data.freq;
    console.log("Ratio L "+ ratio.length + "\n "+s_freq);
    for(let i=0;i<sliders.length;i++){
      sliders[i].value = data.ratio[i];
    }
  });

  var audioCtx = new (window.AudioContext || window.webkitAudioContext)();

  var container = document.getElementById('first');	

  audioCtx.latencyHint = 'interactive';

  var s_ratios = [];
  var sliders = []; 
  var numBoxes = [];
  
 
 
  var rewer = new Tone.JCReverb(0.7).toMaster(audioCtx);
  
  var filter = new Tone.Filter(300,{
                  type  : "lowpass" ,
                  frequency  : 350 ,
                  rolloff  : -12 ,
                  Q  : 3.5 ,
                  gain  : 1.3
                  }).connect(rewer);

  var synth = new Tone.PolySynth(8, sVoice).connect(filter); 
 
  var sVoice = new Tone.Synth(12,"pulse");


  rewer.wet.value = 0.5;
  //Tone.context.latencyHint = 'interactive';
  synth.volume.value = -18;
  
  for (var i = 0; i < 12; i++) {              //  Create Sliders
    numBoxes.push(new Nexus.Number('#f1',{
      'size': [50,25],
      'value': 0.0,
      'min': -1.0,
      'max': 1.0,
      'step': 0.001
    }));
  }

//  Init Tone js and dummy sound test  
  document.querySelector('button').addEventListener('click', () => testCheck());

//  AUDIO CONTEXT START 
  function testCheck(){
    Tone.start();
    Tone.resume = true;
    socket.emit('loadScala', 1);
  }
  
  ///	PIANO UI
  var piano = new Nexus.Piano('#piano',{
    'size': [350,170],
    'mode': 'button',  // 'button', 'toggle', or 'impulse'
    'lowNote': 24,
    'highNote': 36
  });
  
  /// DIV creation
  /// SLIDERS

  htmlString = '';

  for(var i=0; i<12; i++){ 
    //style="float:left;margin: 2px 2px 3px 2px;" 
    htmlString += '<div class="mySlider" style="float:left;margin: 2px 2px 6px 3px;"  id="'+ 
    "slider"+i +'"></div>';
  }
  container.insertAdjacentHTML('beforeend', htmlString);
  //////////////////////////////////////////////////////

  for (var i = 0; i < 12; i++) { //  Create Sliders
    var sName = "#slider" + i;
    sliders.push(new Nexus.Slider(sName));
  }

  for(var i = 0;i<12;i++){
      sliders[i].mode = 'absolute';
      sliders[i].value = 0.00;
      sliders[i].min = 1.000;
      sliders[i].max = 2.000;
      sliders[i].resize(23,100);
      numBoxes[i].link(sliders[i]);
  } 

  sliders.forEach(function(element) {
      element.on('change',function(v){
        let index = sliders.indexOf(element);
        // --> change array notesList
        let oct_index = index;
        for(let oct=1;oct<=1200;oct*=2){
            notesList[oct_index] = ((v * (440.0/16)) * oct).toFixed(3) ;
            oct_index += 12;
        }
      });
  });
  //   PLAY THE CREATED TUNNING 
  piano.on('change',function(v) {
    let thisnote = notesList[v.note-1];

    if(v.state == true){
      synth.triggerAttack(thisnote,"+0.05");
    }else{
      synth.triggerRelease(thisnote,"+0.05");
    }
  });  

  function ResetOffsets(){
    for(let i = 0;i<10;i++){
      sliders[i].value = 0.0;
      numBoxes[i].value = 0.0;
    }
  }
  
</script>
<p>AUDIO GRAPH</p>
<script src="./scripts/visualizer.js"></script>
<div>
    <canvas id="myCanvas" width="400" height="200" style="position: absolute; z-index: 0">"></canvas>
</div>
<div>
  <canvas id="myCanvas2" width="200" height="100" style="position: absolute; z-index: 1"></canvas>></canvas>
</div>
</body>
</html>
